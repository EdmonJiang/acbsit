extends layout
    
block content
  .staffContainer.c-body-top(ng-controller="staffCtrl")
    .container
      h1 AC Staff Information Query
      br
      br
      form#site-form.form-horizontal(ng-submit="submitInfo()")
        div.row
          label.col-sm-2.col-sm-offset-1.search-label(for="qword") Search:
          .col-sm-6.search-box
            input#qword.form-control(type='text' name="q" data-provide="typeahead" autocomplete="off" ng-disabled="searching" ng-model="form.value" placeholder="firstname.lastname or firstname.lastname@xx.atlascopco.com" autofocus)
            span#spinner.loader-circle.input-spinner.hidden
          .col-sm-3
            h5(ng-class="errMsg.class" ng-bind="errMsg.text")
        .col-sm-10.col-sm-offset-1
          .panel(style="text-align: center")
            label.radio-inline
              input(type="radio" name="key" ng-model="form.key" id="name" value="name" ng-checked="true" title="firstname.lastname or firstname.lastname@xx.atlascopco.com")
              |Email
            label.radio-inline
              input(type="radio" name="key" ng-model="form.key" id="OperationalManagerAdMail" value="OperationalManagerAdMail" title="Search users by whose manager's email address")
              |Manager's email
            label.radio-inline
              input(type="radio" name="key" ng-model="form.key" id="LocalJobTitle" value="LocalJobTitle" title="Search users by local job title")
              |Local Job Title  
            label.radio-inline
              input(type="radio" name="key" ng-model="form.key" id="CostCenter" value="CostCenter" title="Search users by Cost Center")
              |Cost Center    
            label.radio-inline
              input(type="radio" name="key" ng-model="form.key" id="Department" value="Department" title="Search users by department name")
              |Department

    .siteinfo
      table.table.table-striped.table-hover.table-condensed
        tr
          th Email Address
          th City
          th Division
          th Local Job Title
          th Department
          th OperationalManager
          th Cost Center
          th FAM Code legal
          th Company FAM Code
          th Company Name
        tr(ng-repeat="user in users")
          td
            span(ng-bind="user.AdMail")
            a.icon-jabber_icon(class="ng-hide" ng-show="user.AdMail" ng-href="im:{{user.AdMail}}")
          td(ng-bind="user.LocationCity")
          td(ng-bind="user.Division")
          td(ng-bind="user.LocalJobTitle")
          td(ng-bind="user.Department")
          td(ng-bind="user.OperationalManager.split('/')[0]")
          td(ng-bind="user.CostCenter")
          td(ng-bind="user.FamCodeLegalUnit")
          td(ng-bind="user.CompanyFamCode")
          td(ng-bind="user.CompanyName")

append script
  script(src='//cdn.bootcss.com/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js')
  script.
    $(function() {
      (function() {
        var $input = $("#qword");

        $("input:radio").on("click", function() {
          var tip = $(this).attr("title");
          $input.attr("placeholder", tip);
          $input.typeahead('destroy');
          var name = $(this).val();
          setTypeahead($input, name);
        })

        setTimeout(function(){
          $('input[type=radio][checked]').click();
        }, 500)

        var $spinner = $("#spinner");
        function setTypeahead(objInput, name) {
          objInput.typeahead({
            delay: 700,
            fitToElement: true,
            source: function(query, callback){
              if(!query.trim() || !objInput.val()){
                return;
              }
              $spinner.removeClass("hidden");
              $.getJSON('/cmdb/staff/users/list/?key='+name+'&value='+query, function(data){
                var list = data.map(function(item){
                    return item._id;
                })
                $spinner.addClass("hidden");
                if(!list.length){
                  return;
                }
                callback(list);
              })
            },
            matcher: function(item){
              return item;
            }
          })
        }

      })();
    });